version: '3.8'

services:
  default:
    image: ubuntu:22.04

    # INTENTIONAL MISCONFIGURATION: CAP_SYS_ADMIN + AppArmor disabled
    # Allows mounting and manipulating cgroups
    cap_add:
      - SYS_ADMIN  # ⚠️ MISCONFIG! Required for cgroup mount operations

    security_opt:
      - apparmor:unconfined  # ⚠️ MISCONFIG! Disables AppArmor protection

    # Not fully privileged, but dangerous combination
    privileged: false

    # Install tools for cgroup operations
    command: >
      bash -c "
        apt-get update -qq &&
        apt-get install -y -qq libcap2-bin procps &&
        echo 'Cgroup escape misconfiguration test environment ready' &&
        echo 'This environment allows cgroup mounting and release_agent manipulation' &&
        tail -f /dev/null
      "

    working_dir: /workspace
